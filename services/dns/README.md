## DNS系统 5个部分：

### dnscache.service (别名 dnsmasq.service)
监听53端口，仅作缓存和输入筛选（去掉垃圾攻击数据），无任何其他功能，直接转发所有请求到resolved

TODO: 研究防火墙

### systemd-resolved.service
系统的一部分，监听5353端口，正常应该监听53，但由于目前缺少反攻击能力，只能先放别的端口。

缓存

当监听53端口时有此功能：*根据\*.network文件判断来的请求应添加什么后缀*

目前无功能，只是无条件转发给下一级

#### dnsdispatch.service
分辨请求应该发往国内还是国外

目前直接使用chinadns-ng全权负责

chinadns同时还在nftables维护着`chnip6/4`和`gfwip6/4`，不过这两个表目前没用到

#### dnsconvert.service
实现2个功能：
* 把多个服务器聚合成一个
* 对于国外服务器，将UDP请求转换成TCP请求（以防代理服务器不支持UDP转发）

#### dnsproxy.service
普通的代理服务，专门用于解析DNS（建立几个通向国外DNS服务器的隧道）

## 分配表

| 端口/协议 |作用| 程序 | 下一级|
|----|----|----|----|
| 53 | 缓存 | dnsmasq | `127.0.0.1#5353` |
| 5353 | 缓存、请求路由（本地外埠分辨） | systemd-resolved | `127.0.0.1#5300` `127.0.0.1#5354` `127.0.0.1#5356` |
| 5300 | 请求路由（海内外分辨） | chinadns-ng | `::1#5306` `::1#5305` |
| 5305 | 国内解析 | Coredns | 国内公用DNS服务器 |
| 5306 | 海外解析 | Coredns | `::1#5340-5349` |
| 5340-5349 | TCP隧道端口 | clash | 国外公用DNS服务器 |
| 5354 | DHCP本地解析 | dnsmasq | - |
| 5356 | VPN本地解析 | dnsmasq | - |
